{% extends "base.html" %}

{% block title %}{{ lesson.title }} — Ochiq kurs{% endblock %}

{% block content %}
<style>
@media (min-width: 1024px) {
  main.content { max-width: 1180px; }
}
</style>

<nav class="breadcrumb">
  <a href="{% url 'learning:skill_detail' skill.slug %}">{{ skill.title }}</a>
  &rsaquo;
  <a href="{% url 'learning:subskill_detail' skill.slug subskill.slug %}">{{ subskill.title }}</a>
  &rsaquo; {{ lesson.title }}
</nav>

<h1>{{ lesson.title }}</h1>

{% if user.is_authenticated %}
<div class="lesson-grid">

  <div class="lesson-main">
    {% if lesson_description_html %}
      <div class="md-content lesson-desc">{{ lesson_description_html }}</div>
    {% endif %}

    <!-- YouTube embed -->
    <div class="video-wrapper">
      <iframe
        src="https://www.youtube.com/embed/{{ lesson.youtube_video_id }}"
        title="{{ lesson.title }}"
        frameborder="0"
        referrerpolicy="strict-origin-when-cross-origin"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
        >
      </iframe>
    </div>

    <!-- Mark complete -->
    <div class="complete-section">
      {% if progress.is_completed %}
        <p class="completed-badge">&#10003; Completed</p>
      {% else %}
        <button
          id="btn-complete"
          class="btn-primary"
          data-url="{% url 'learning:mark_complete' skill.slug subskill.slug lesson.slug %}"
        >
          Tugatilgan deb belgilash
        </button>
      {% endif %}
    </div>

    <!-- Prev / Next navigation -->
    <div class="lesson-nav">
      {% if prev_lesson %}
        <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug prev_lesson.slug %}">
          &larr; {{ prev_lesson.title }}
        </a>
      {% else %}
        <span></span>
      {% endif %}
      {% if next_lesson %}
        <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug next_lesson.slug %}">
          {{ next_lesson.title }} &rarr;
        </a>
      {% endif %}
    </div>
  </div>

  <aside class="lesson-notes-panel">
    <div class="notes-panel-inner">
      <p class="notes-panel-header">Konspekt</p>

      {% if note_rendered %}
        <div class="note-preview md-content">{{ note_rendered }}</div>
        <hr class="notes-divider">
      {% endif %}

      <textarea
        id="note-content"
        class="note-textarea"
        placeholder="Markdown yozing... (```python kodi ```)">{{ note.content|default:'' }}</textarea>

      <div class="note-actions">
        <button
          id="btn-save-note"
          class="btn-primary"
          data-url="{% url 'learning:save_note' skill.slug subskill.slug lesson.slug %}"
        >
          Saqlash
        </button>
        <span id="note-status" class="note-status"></span>
      </div>
    </div>
  </aside>

</div>
{% else %}
<!-- Unauthenticated: single column, no notes panel -->
<div class="lesson-main">
  {% if lesson_description_html %}
    <div class="md-content lesson-desc">{{ lesson_description_html }}</div>
  {% endif %}

  <!-- YouTube embed -->
  <div class="video-wrapper">
    <iframe
      src="https://www.youtube.com/embed/{{ lesson.youtube_video_id }}"
      title="{{ lesson.title }}"
      frameborder="0"
      referrerpolicy="strict-origin-when-cross-origin"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      >
    </iframe>
  </div>

  <!-- Mark complete -->
  <div class="complete-section">
    {% if progress.is_completed %}
      <p class="completed-badge">&#10003; Completed</p>
    {% else %}
      <button
        id="btn-complete"
        class="btn-primary"
        data-url="{% url 'learning:mark_complete' skill.slug subskill.slug lesson.slug %}"
      >
        Tugatilgan deb belgilash
      </button>
    {% endif %}
  </div>

  <!-- Prev / Next navigation -->
  <div class="lesson-nav">
    {% if prev_lesson %}
      <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug prev_lesson.slug %}">
        &larr; {{ prev_lesson.title }}
      </a>
    {% else %}
      <span></span>
    {% endif %}
    {% if next_lesson %}
      <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug next_lesson.slug %}">
        {{ next_lesson.title }} &rarr;
      </a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Syntax highlighting for code blocks in description and notes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
(function () {
  // Normalize class="python" → class="language-python" for Highlight.js
  document.querySelectorAll('pre code[class]').forEach(function (el) {
    var c = el.className;
    if (!c.startsWith('language-') && !c.startsWith('hljs')) {
      el.classList.replace(c, 'language-' + c);
    }
  });
  hljs.highlightAll();
}());
</script>

<script>
(function () {
  // Mark lesson complete
  var btnComplete = document.getElementById('btn-complete');
  if (btnComplete) {
    btnComplete.addEventListener('click', function () {
      fetch(btnComplete.dataset.url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
      })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.status === 'ok') {
          var badge = document.createElement('p');
          badge.className = 'completed-badge';
          badge.textContent = '\u2713 Completed';
          btnComplete.parentNode.replaceChild(badge, btnComplete);
        }
      })
      .catch(function (err) { console.error('Error marking lesson complete:', err); });
    });
  }

  // Save note
  var btnNote = document.getElementById('btn-save-note');
  var noteStatus = document.getElementById('note-status');
  if (btnNote) {
    btnNote.addEventListener('click', function () {
      var content = document.getElementById('note-content').value;
      fetch(btnNote.dataset.url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({ content: content }),
      })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.status === 'ok') {
          noteStatus.textContent = '\u2713 Saqlandi';
          noteStatus.className = 'note-status note-status-ok';
          setTimeout(function () { noteStatus.textContent = ''; }, 2500);
        }
      })
      .catch(function (err) { console.error('Note save error:', err); });
    });
  }
}());
</script>
{% endblock %}
