{% extends "base.html" %}

{% block title %}{{ lesson.title }} — Ochiq kurs{% endblock %}

{% block content %}
<style>
@media (min-width: 1024px) {
  main.content { max-width: none; }
}
</style>

<nav class="breadcrumb">
  <a href="{% url 'learning:skill_detail' skill.slug %}">{{ skill.title }}</a>
  &rsaquo;
  <a href="{% url 'learning:subskill_detail' skill.slug subskill.slug %}">{{ subskill.title }}</a>
  &rsaquo; {{ lesson.title }}
</nav>

<h1>{{ lesson.title }}</h1>

{% if user.is_authenticated %}
<div class="lesson-grid">

  <div class="lesson-main">
    
    <!-- YouTube IFrame API player (tracking enabled for authenticated users) -->
    <div class="video-wrapper">
      <div id="yt-player"></div>
    </div>
  
  {% if lesson_description_html %}
    <div class="md-content lesson-desc">{{ lesson_description_html }}</div>
  {% endif %}
  
    <!-- Mark complete -->
    <div class="complete-section">
      {% if progress.is_completed %}
        <p class="completed-badge">&#10003; Completed</p>
      {% else %}
        <button
          id="btn-complete"
          class="btn-primary"
          data-url="{% url 'learning:mark_complete' skill.slug subskill.slug lesson.slug %}"
        >
          Tugatilgan deb belgilash
        </button>
      {% endif %}
    </div>

    <!-- Prev / Next navigation -->
    <div class="lesson-nav">
      {% if prev_lesson %}
        <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug prev_lesson.slug %}">
          &larr; {{ prev_lesson.title }}
        </a>
      {% else %}
        <span></span>
      {% endif %}
      {% if next_lesson %}
        <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug next_lesson.slug %}">
          {{ next_lesson.title }} &rarr;
        </a>
      {% endif %}
    </div>
  </div>

  <aside class="lesson-notes-panel">
    <div class="notes-panel-inner">
      <p class="notes-panel-header">Qaydlar</p>

      <div id="note-preview" class="note-preview md-content{% if not note_rendered %} note-hidden{% endif %}">{{ note_rendered }}</div>

      <button id="btn-edit-note" class="btn-secondary btn-sm{% if not note_rendered %} note-hidden{% endif %}">
        Tahrirlash
      </button>

      <div id="note-editor" class="note-editor{% if note_rendered %} note-hidden{% endif %}">
        <textarea
          id="note-content"
          class="note-textarea"
          placeholder="Markdown yozing... (```python kodi ```)">{{ note.content|default:'' }}</textarea>

        <div class="note-actions">
          <button
            id="btn-save-note"
            class="btn-primary"
            data-url="{% url 'learning:save_note' skill.slug subskill.slug lesson.slug %}"
          >
            Saqlash
          </button>
          <span id="note-status" class="note-status"></span>
        </div>
      </div>
    </div>
  </aside>

</div>
{% else %}
<!-- Unauthenticated: single column, no notes panel -->
<div class="lesson-main">
  {% if lesson_description_html %}
    <div class="md-content lesson-desc">{{ lesson_description_html }}</div>
  {% endif %}

  <!-- YouTube embed -->
  <div class="video-wrapper">
    <iframe
      src="https://www.youtube.com/embed/{{ lesson.youtube_video_id }}"
      title="{{ lesson.title }}"
      frameborder="0"
      referrerpolicy="strict-origin-when-cross-origin"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      >
    </iframe>
  </div>

  <!-- Mark complete -->
  <div class="complete-section">
    {% if progress.is_completed %}
      <p class="completed-badge">&#10003; Completed</p>
    {% else %}
      <button
        id="btn-complete"
        class="btn-primary"
        data-url="{% url 'learning:mark_complete' skill.slug subskill.slug lesson.slug %}"
      >
        Tugatilgan deb belgilash
      </button>
    {% endif %}
  </div>

  <!-- Prev / Next navigation -->
  <div class="lesson-nav">
    {% if prev_lesson %}
      <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug prev_lesson.slug %}">
        &larr; {{ prev_lesson.title }}
      </a>
    {% else %}
      <span></span>
    {% endif %}
    {% if next_lesson %}
      <a class="btn-secondary" href="{% url 'learning:lesson_detail' skill.slug subskill.slug next_lesson.slug %}">
        {{ next_lesson.title }} &rarr;
      </a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Syntax highlighting for code blocks in description and notes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
(function () {
  // Normalize class="python" → class="language-python" for Highlight.js
  document.querySelectorAll('pre code[class]').forEach(function (el) {
    var c = el.className;
    if (!c.startsWith('language-') && !c.startsWith('hljs')) {
      el.classList.replace(c, 'language-' + c);
    }
  });
  hljs.highlightAll();
}());
</script>

<script>
(function () {
  // Mark lesson complete
  var btnComplete = document.getElementById('btn-complete');
  if (btnComplete) {
    btnComplete.addEventListener('click', function () {
      fetch(btnComplete.dataset.url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
      })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.status === 'ok') {
          var badge = document.createElement('p');
          badge.className = 'completed-badge';
          badge.textContent = '\u2713 Completed';
          btnComplete.parentNode.replaceChild(badge, btnComplete);
        }
      })
      .catch(function (err) { console.error('Error marking lesson complete:', err); });
    });
  }

  // Note edit/preview toggle
  var btnEdit = document.getElementById('btn-edit-note');
  var noteEditor = document.getElementById('note-editor');
  var notePreview = document.getElementById('note-preview');
  if (btnEdit) {
    btnEdit.addEventListener('click', function () {
      notePreview.classList.add('note-hidden');
      btnEdit.classList.add('note-hidden');
      noteEditor.classList.remove('note-hidden');
      document.getElementById('note-content').focus();
    });
  }

  // Save note
  var btnNote = document.getElementById('btn-save-note');
  var noteStatus = document.getElementById('note-status');
  if (btnNote) {
    btnNote.addEventListener('click', function () {
      var content = document.getElementById('note-content').value;
      fetch(btnNote.dataset.url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({ content: content }),
      })
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.status === 'ok') {
          noteStatus.textContent = '\u2713 Saqlandi';
          noteStatus.className = 'note-status note-status-ok';
          // Update preview with server-rendered markdown
          if (notePreview && data.rendered !== undefined) {
            notePreview.innerHTML = data.rendered || '';
            notePreview.querySelectorAll('pre code').forEach(function (el) {
              if (typeof hljs !== 'undefined') { hljs.highlightElement(el); }
            });
          }
          // Switch to preview mode after a brief pause so user sees "Saqlandi"
          setTimeout(function () {
            noteStatus.textContent = '';
            if (content.trim() && noteEditor && notePreview) {
              noteEditor.classList.add('note-hidden');
              notePreview.classList.remove('note-hidden');
              if (btnEdit) { btnEdit.classList.remove('note-hidden'); }
            }
          }, 800);
        }
      })
      .catch(function (err) { console.error('Note save error:', err); });
    });
  }
}());
</script>

<script>
(function () {
  var LESSON_ID   = {{ lesson.id }};
  var VIDEO_ID    = '{{ lesson.youtube_video_id }}';
  var CSRF        = '{{ csrf_token }}';
  var URL_START   = '{% url "learning:session_start" skill.slug subskill.slug lesson.slug %}';
  var URL_EVENT   = '{% url "learning:session_event" skill.slug subskill.slug lesson.slug %}';
  var URL_BEACON  = '{% url "learning:session_beacon" skill.slug subskill.slug lesson.slug %}';
  var SESSION_KEY = 'session_' + LESSON_ID;

  var player, sessionId, heartbeatTimer;
  var pauseTime = null;

  // Warn if YT IFrame API does not fire within 5 seconds
  var ytReady = false;
  var ytTimeout = setTimeout(function () {
    if (!ytReady) { console.warn('YouTube IFrame API did not fire within 5 s'); }
  }, 5000);

  window.onYouTubeIframeAPIReady = function () {
    ytReady = true;
    clearTimeout(ytTimeout);
    player = new YT.Player('yt-player', {
      videoId: VIDEO_ID,
      playerVars: { rel: 0 },
      events: {
        onReady: onPlayerReady,
        onStateChange: onStateChange,
        onPlaybackRateChange: onRateChange,
      },
    });
  };

  function onPlayerReady(event) {
    var duration = player.getDuration();
    sessionId = sessionStorage.getItem(SESSION_KEY);
    if (sessionId) { return; }
    fetch(URL_START, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF, 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ duration_seconds: Math.round(duration) }),
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      sessionId = d.session_id;
      sessionStorage.setItem(SESSION_KEY, sessionId);
      sessionStorage.setItem(SESSION_KEY + '_ts', Date.now());
    })
    .catch(function (e) { console.error('session/start error:', e); });
  }

  function sendEvent(type, position, metadata) {
    if (!sessionId) { return; }
    fetch(URL_EVENT, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF, 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        session_id: sessionId,
        event_type: type,
        position_seconds: Math.round(position),
        metadata: metadata || {},
      }),
    })
    .then(function (r) { return r.json(); })
    .then(function (d) {
      if (d.auto_completed) { markCompletedInUI(); }
    })
    .catch(function (e) { console.error('session/event error:', e); });
  }

  function onStateChange(event) {
    var t = player.getCurrentTime();
    if (event.data === YT.PlayerState.PLAYING) {
      // Detect seek: position jumped more than 2 s from where we last paused
      if (pauseTime !== null && Math.abs(t - pauseTime) > 2) {
        sendEvent('seek', pauseTime, { seek_to: Math.round(t) });
      }
      pauseTime = null;
      sendEvent('play', t, {});
      clearInterval(heartbeatTimer);
      heartbeatTimer = setInterval(function () {
        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
          sendEvent('heartbeat', player.getCurrentTime(), {});
        }
      }, 10000);
    } else if (event.data === YT.PlayerState.PAUSED) {
      pauseTime = t;
      clearInterval(heartbeatTimer);
      sendEvent('pause', t, {});
    } else if (event.data === YT.PlayerState.ENDED) {
      pauseTime = null;
      clearInterval(heartbeatTimer);
      sendEvent('ended', t, {});
    }
  }

  function onRateChange(event) {
    if (!sessionId) { return; }
    sendEvent('speed_change', player.getCurrentTime(), { playback_rate: event.data });
  }

  document.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden') {
      if (!sessionId) { return; }
      clearInterval(heartbeatTimer);
      var pos = player ? Math.round(player.getCurrentTime()) : 0;
      var payload = JSON.stringify({
        session_id: sessionId,
        event_type: 'page_hidden',
        position_seconds: pos,
        metadata: {},
      });
      navigator.sendBeacon(URL_BEACON, new Blob([payload], { type: 'application/json' }));
      sessionStorage.setItem(SESSION_KEY + '_ts', Date.now());
    } else if (document.visibilityState === 'visible') {
      var ts = parseInt(sessionStorage.getItem(SESSION_KEY + '_ts') || '0', 10);
      var elapsedMin = (Date.now() - ts) / 60000;
      if (elapsedMin > 30) {
        // More than 30 min away — start a fresh session
        sessionStorage.removeItem(SESSION_KEY);
        sessionStorage.removeItem(SESSION_KEY + '_ts');
        sessionId = null;
        if (player) {
          var dur = player.getDuration();
          fetch(URL_START, {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF, 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ duration_seconds: Math.round(dur) }),
          })
          .then(function (r) { return r.json(); })
          .then(function (d) {
            sessionId = d.session_id;
            sessionStorage.setItem(SESSION_KEY, sessionId);
            sessionStorage.setItem(SESSION_KEY + '_ts', Date.now());
          })
          .catch(function (e) { console.error('session/start error:', e); });
        }
      }
      // else: within 30 min — keep sessionId (backend reactivated on page_hidden)
    }
  });

  function markCompletedInUI() {
    var btn = document.getElementById('btn-complete');
    if (btn) {
      var badge = document.createElement('p');
      badge.className = 'completed-badge';
      badge.textContent = '\u2713 Completed';
      btn.parentNode.replaceChild(badge, btn);
    }
  }

  // Load YouTube IFrame API
  var tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(tag);
}());
</script>
{% endblock %}
